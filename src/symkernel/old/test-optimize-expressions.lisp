


;; Input rules are (expr -> var) s-exprs
(defparameter *pack*
  (opt-exp::make-pack
                 :name "demo"
                 :outputs '(out1 out2)
                 :rules (list
                         (opt-exp::make-rule '(* (+ a b) (+ a b)) 'out1)
                         (opt-exp::make-rule '(+ (* x y) (* x y) out1) 'out2))))

(defparameter newpack (opt-exp::pack-optimize *pack*))
;; Returns a plist with :rules optimized by CSE and pair factoring for * and +




;; Build a pack with unordered rules
(let* ((r1 (make-rule (make-call '+ (list 'a 'b)) :tzz1))
       (r2 (make-rule (make-call '* (list :tzz1 :tzz1)) 'out1))
       (r3 (make-rule (make-call '* (list 'x 'y)) :tzz2))
       (r4 (make-rule (make-call '+ (list :tzz2 :tzz2 'z)) 'out2))
       (pk (make-pack "demo" '(out1 out2) (list r1 r2 r3 r4)))
       (pk2 (pack-optimize pk)))
  (mapcar #'rule->sexp (rules pk2)))

(in-package :opt-exp)


(defparameter pack (make-pack :name "Nonbond" :outputs '(DeltaX DeltaY DeltaZ Energy Evdw Eeel fx1 fy1 fz1 fx2 fy2 fz2 dhx1x1 dhy1y1 dhz1z1 dhx2x2 dhy2y2 dhz2z2 ohx1y1 ohx1z1 ohx1x2 ohx1y2 ohx1z2 ohy1z1 ohy1x2 ohy1y2 ohy1z2 ohz1x2 ohz1y2 ohz1z2 ohx2y2 ohx2z2 ohy2z2 NonbondDistance)
                              :rules (list   (CCode "NONBOND_SET_PARAMETER(dQ1Q2);")
                                             (CCode "NONBOND_SET_PARAMETER(dA);")
                                             (CCode "NONBOND_SET_PARAMETER(dC);")
                                             (CCode "NONBOND_SET_PARAMETER(I1);")
                                             (CCode "NONBOND_SET_PARAMETER(I2);")
                                             (CCode "NONBOND_APPLY_ATOM_MASK(I1,I2);")
                                             (CCode "NONBOND_SET_POSITION(x1,I1,0);")
                                             (CCode "NONBOND_SET_POSITION(y1,I1,1);")
                                             (CCode "NONBOND_SET_POSITION(z1,I1,2);")
                                             (CCode "NONBOND_SET_POSITION(x2,I2,0);")
                                             (CCode "NONBOND_SET_POSITION(y2,I2,1);")
                                             (CCode "NONBOND_SET_POSITION(z2,I2,2);")
                                             (make-rule '(+ (* -1 x1) x2) 'DeltaX)
                                             (make-rule '(+ (* -1 y1) y2) 'DeltaY)
                                             (make-rule '(+ (* -1 z1) z2) 'DeltaZ)
                                             (make-rule '(+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) 'DistanceSquared)
                                             (CCode "BAIL_OUT_IF_CUTOFF(DistanceSquared)")
                                             (make-rule '(* vdwScale (+ (* dA (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -6)) (* -1 dC (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -3)))) 'Evdw)
                                             (CCode "NONBOND_EVDW_ENERGY_ACCUMULATE(Evdw);")
                                             (make-rule '(* (expt DIELECTRIC -1) dQ1Q2 eelScale (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -1/2)) 'Eeel)
                                             (CCode "NONBOND_EEEL_ENERGY_ACCUMULATE(Eeel);")
                                             (make-rule '(+ Eeel Evdw) 'Energy)
                                             (CCode "NONBOND_ENERGY_ACCUMULATE(Energy);")
                                             (CCode "#ifdef NONBOND_CALC_FORCE //[")
                                             (CCode "if ( calcForce ) {")
                                             (make-rule '(+ (* (expt DIELECTRIC -1) dQ1Q2 eelScale (PBX (+ (* -1 x1) x2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -3/2)) (* vdwScale (+ (* 12 dA (PBX (+ (* -1 x1) x2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -7)) (* -6 dC (PBX (+ (* -1 x1) x2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -4))))) 'gx1)
                                             (make-rule '(* -1 gx1) 'fx1)
                                             (CCode "NONBOND_FORCE_ACCUMULATE(I1, 0, fx1 );")
                                             (make-rule '(+ (* (expt DIELECTRIC -1) dQ1Q2 eelScale (PBY (+ (* -1 y1) y2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -3/2)) (* vdwScale (+ (* 12 dA (PBY (+ (* -1 y1) y2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -7)) (* -6 dC (PBY (+ (* -1 y1) y2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -4))))) 'gy1)
                                             (make-rule '(* -1 gy1) 'fy1)
                                             (CCode "NONBOND_FORCE_ACCUMULATE(I1, 1, fy1 );")
                                             (make-rule '(+ (* (expt DIELECTRIC -1) dQ1Q2 eelScale (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -3/2)) (* vdwScale (+ (* 12 dA (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -7)) (* -6 dC (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -4))))) 'gz1)
                                             (make-rule '(* -1 gz1) 'fz1)
                                             (CCode "NONBOND_FORCE_ACCUMULATE(I1, 2, fz1 );")
                                             (make-rule '(+ (* -1 (expt DIELECTRIC -1) dQ1Q2 eelScale (PBX (+ (* -1 x1) x2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -3/2)) (* vdwScale (+ (* -12 dA (PBX (+ (* -1 x1) x2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -7)) (* 6 dC (PBX (+ (* -1 x1) x2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -4))))) 'gx2)
                                             (make-rule '(* -1 gx2) 'fx2)
                                             (CCode "NONBOND_FORCE_ACCUMULATE(I2, 0, fx2 );")
                                             (make-rule '(+ (* -1 (expt DIELECTRIC -1) dQ1Q2 eelScale (PBY (+ (* -1 y1) y2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -3/2)) (* vdwScale (+ (* -12 dA (PBY (+ (* -1 y1) y2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -7)) (* 6 dC (PBY (+ (* -1 y1) y2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -4))))) 'gy2)
                                             (make-rule '(* -1 gy2) 'fy2)
                                             (CCode "NONBOND_FORCE_ACCUMULATE(I2, 1, fy2 );")
                                             (make-rule '(+ (* -1 (expt DIELECTRIC -1) dQ1Q2 eelScale (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -3/2)) (* vdwScale (+ (* -12 dA (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -7)) (* 6 dC (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -4))))) 'gz2)
                                             (make-rule '(* -1 gz2) 'fz2)
                                             (CCode "NONBOND_FORCE_ACCUMULATE(I2, 2, fz2 );")
                                             (CCode "#ifdef NONBOND_CALC_DIAGONAL_HESSIAN //[")
                                             (CCode "if ( calcDiagonalHessian ) {")
                                             (make-rule '(+ (* 3 (expt DIELECTRIC -1) dQ1Q2 eelScale (expt (PBX (+ (* -1 x1) x2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* -1 (expt DIELECTRIC -1) dQ1Q2 eelScale (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -3/2)) (* vdwScale (+ (* 168 dA (expt (PBX (+ (* -1 x1) x2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* -12 dA (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -7)) (* -48 dC (expt (PBX (+ (* -1 x1) x2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5)) (* 6 dC (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -4))))) 'dhx1x1)
                                             (CCode "NONBOND_DIAGONAL_HESSIAN_ACCUMULATE(I1, 0, I1, 0, dhx1x1);")
                                             (make-rule '(+ (* 3 (expt DIELECTRIC -1) dQ1Q2 eelScale (expt (PBY (+ (* -1 y1) y2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* -1 (expt DIELECTRIC -1) dQ1Q2 eelScale (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -3/2)) (* vdwScale (+ (* 168 dA (expt (PBY (+ (* -1 y1) y2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* -12 dA (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -7)) (* -48 dC (expt (PBY (+ (* -1 y1) y2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5)) (* 6 dC (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -4))))) 'dhy1y1)
                                             (CCode "NONBOND_DIAGONAL_HESSIAN_ACCUMULATE(I1, 1, I1, 1, dhy1y1);")
                                             (make-rule '(+ (* 3 (expt DIELECTRIC -1) dQ1Q2 eelScale (expt (PBZ (+ (* -1 z1) z2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* -1 (expt DIELECTRIC -1) dQ1Q2 eelScale (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -3/2)) (* vdwScale (+ (* 168 dA (expt (PBZ (+ (* -1 z1) z2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* -12 dA (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -7)) (* -48 dC (expt (PBZ (+ (* -1 z1) z2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5)) (* 6 dC (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -4))))) 'dhz1z1)
                                             (CCode "NONBOND_DIAGONAL_HESSIAN_ACCUMULATE(I1, 2, I1, 2, dhz1z1);")
                                             (make-rule '(+ (* 3 (expt DIELECTRIC -1) dQ1Q2 eelScale (expt (PBX (+ (* -1 x1) x2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* -1 (expt DIELECTRIC -1) dQ1Q2 eelScale (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -3/2)) (* vdwScale (+ (* 168 dA (expt (PBX (+ (* -1 x1) x2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* -12 dA (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -7)) (* -48 dC (expt (PBX (+ (* -1 x1) x2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5)) (* 6 dC (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -4))))) 'dhx2x2)
                                             (CCode "NONBOND_DIAGONAL_HESSIAN_ACCUMULATE(I2, 0, I2, 0, dhx2x2);")
                                             (make-rule '(+ (* 3 (expt DIELECTRIC -1) dQ1Q2 eelScale (expt (PBY (+ (* -1 y1) y2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* -1 (expt DIELECTRIC -1) dQ1Q2 eelScale (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -3/2)) (* vdwScale (+ (* 168 dA (expt (PBY (+ (* -1 y1) y2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* -12 dA (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -7)) (* -48 dC (expt (PBY (+ (* -1 y1) y2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5)) (* 6 dC (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -4))))) 'dhy2y2)
                                             (CCode "NONBOND_DIAGONAL_HESSIAN_ACCUMULATE(I2, 1, I2, 1, dhy2y2);")
                                             (make-rule '(+ (* 3 (expt DIELECTRIC -1) dQ1Q2 eelScale (expt (PBZ (+ (* -1 z1) z2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* -1 (expt DIELECTRIC -1) dQ1Q2 eelScale (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -3/2)) (* vdwScale (+ (* 168 dA (expt (PBZ (+ (* -1 z1) z2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* -12 dA (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -7)) (* -48 dC (expt (PBZ (+ (* -1 z1) z2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5)) (* 6 dC (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -4))))) 'dhz2z2)
                                             (CCode "NONBOND_DIAGONAL_HESSIAN_ACCUMULATE(I2, 2, I2, 2, dhz2z2);")
                                             (CCode "#ifdef NONBOND_CALC_OFF_DIAGONAL_HESSIAN //[")
                                             (CCode "if ( calcOffDiagonalHessian ) {")
                                             (make-rule '(+ (* 3 (expt DIELECTRIC -1) dQ1Q2 eelScale (PBX (+ (* -1 x1) x2)) (PBY (+ (* -1 y1) y2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* vdwScale (+ (* 168 dA (PBX (+ (* -1 x1) x2)) (PBY (+ (* -1 y1) y2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* -48 dC (PBX (+ (* -1 x1) x2)) (PBY (+ (* -1 y1) y2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5))))) 'ohx1y1)
                                             (CCode "NONBOND_OFF_DIAGONAL_HESSIAN_ACCUMULATE(I1, 0, I1, 1, ohx1y1);")
                                             (make-rule '(+ (* 3 (expt DIELECTRIC -1) dQ1Q2 eelScale (PBX (+ (* -1 x1) x2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* vdwScale (+ (* 168 dA (PBX (+ (* -1 x1) x2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* -48 dC (PBX (+ (* -1 x1) x2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5))))) 'ohx1z1)
                                             (CCode "NONBOND_OFF_DIAGONAL_HESSIAN_ACCUMULATE(I1, 0, I1, 2, ohx1z1);")
                                             (make-rule '(+ (* -3 (expt DIELECTRIC -1) dQ1Q2 eelScale (expt (PBX (+ (* -1 x1) x2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* (expt DIELECTRIC -1) dQ1Q2 eelScale (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -3/2)) (* vdwScale (+ (* -168 dA (expt (PBX (+ (* -1 x1) x2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* 12 dA (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -7)) (* 48 dC (expt (PBX (+ (* -1 x1) x2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5)) (* -6 dC (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -4))))) 'ohx1x2)
                                             (CCode "NONBOND_OFF_DIAGONAL_HESSIAN_ACCUMULATE(I1, 0, I2, 0, ohx1x2);")
                                             (make-rule '(+ (* -3 (expt DIELECTRIC -1) dQ1Q2 eelScale (PBX (+ (* -1 x1) x2)) (PBY (+ (* -1 y1) y2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* vdwScale (+ (* -168 dA (PBX (+ (* -1 x1) x2)) (PBY (+ (* -1 y1) y2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* 48 dC (PBX (+ (* -1 x1) x2)) (PBY (+ (* -1 y1) y2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5))))) 'ohx1y2)
                                             (CCode "NONBOND_OFF_DIAGONAL_HESSIAN_ACCUMULATE(I1, 0, I2, 1, ohx1y2);")
                                             (make-rule '(+ (* -3 (expt DIELECTRIC -1) dQ1Q2 eelScale (PBX (+ (* -1 x1) x2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* vdwScale (+ (* -168 dA (PBX (+ (* -1 x1) x2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* 48 dC (PBX (+ (* -1 x1) x2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5))))) 'ohx1z2)
                                             (CCode "NONBOND_OFF_DIAGONAL_HESSIAN_ACCUMULATE(I1, 0, I2, 2, ohx1z2);")
                                             (make-rule '(+ (* 3 (expt DIELECTRIC -1) dQ1Q2 eelScale (PBY (+ (* -1 y1) y2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* vdwScale (+ (* 168 dA (PBY (+ (* -1 y1) y2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* -48 dC (PBY (+ (* -1 y1) y2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5))))) 'ohy1z1)
                                             (CCode "NONBOND_OFF_DIAGONAL_HESSIAN_ACCUMULATE(I1, 1, I1, 2, ohy1z1);")
                                             (make-rule '(+ (* -3 (expt DIELECTRIC -1) dQ1Q2 eelScale (PBX (+ (* -1 x1) x2)) (PBY (+ (* -1 y1) y2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* vdwScale (+ (* -168 dA (PBX (+ (* -1 x1) x2)) (PBY (+ (* -1 y1) y2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* 48 dC (PBX (+ (* -1 x1) x2)) (PBY (+ (* -1 y1) y2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5))))) 'ohy1x2)
                                             (CCode "NONBOND_OFF_DIAGONAL_HESSIAN_ACCUMULATE(I1, 1, I2, 0, ohy1x2);")
                                             (make-rule '(+ (* -3 (expt DIELECTRIC -1) dQ1Q2 eelScale (expt (PBY (+ (* -1 y1) y2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* (expt DIELECTRIC -1) dQ1Q2 eelScale (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -3/2)) (* vdwScale (+ (* -168 dA (expt (PBY (+ (* -1 y1) y2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* 12 dA (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -7)) (* 48 dC (expt (PBY (+ (* -1 y1) y2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5)) (* -6 dC (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -4))))) 'ohy1y2)
                                             (CCode "NONBOND_OFF_DIAGONAL_HESSIAN_ACCUMULATE(I1, 1, I2, 1, ohy1y2);")
                                             (make-rule '(+ (* -3 (expt DIELECTRIC -1) dQ1Q2 eelScale (PBY (+ (* -1 y1) y2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* vdwScale (+ (* -168 dA (PBY (+ (* -1 y1) y2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* 48 dC (PBY (+ (* -1 y1) y2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5))))) 'ohy1z2)
                                             (CCode "NONBOND_OFF_DIAGONAL_HESSIAN_ACCUMULATE(I1, 1, I2, 2, ohy1z2);")
                                             (make-rule '(+ (* -3 (expt DIELECTRIC -1) dQ1Q2 eelScale (PBX (+ (* -1 x1) x2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* vdwScale (+ (* -168 dA (PBX (+ (* -1 x1) x2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* 48 dC (PBX (+ (* -1 x1) x2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5))))) 'ohz1x2)
                                             (CCode "NONBOND_OFF_DIAGONAL_HESSIAN_ACCUMULATE(I1, 2, I2, 0, ohz1x2);")
                                             (make-rule '(+ (* -3 (expt DIELECTRIC -1) dQ1Q2 eelScale (PBY (+ (* -1 y1) y2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* vdwScale (+ (* -168 dA (PBY (+ (* -1 y1) y2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* 48 dC (PBY (+ (* -1 y1) y2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5))))) 'ohz1y2)
                                             (CCode "NONBOND_OFF_DIAGONAL_HESSIAN_ACCUMULATE(I1, 2, I2, 1, ohz1y2);")
                                             (make-rule '(+ (* -3 (expt DIELECTRIC -1) dQ1Q2 eelScale (expt (PBZ (+ (* -1 z1) z2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* (expt DIELECTRIC -1) dQ1Q2 eelScale (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -3/2)) (* vdwScale (+ (* -168 dA (expt (PBZ (+ (* -1 z1) z2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* 12 dA (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -7)) (* 48 dC (expt (PBZ (+ (* -1 z1) z2)) 2) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5)) (* -6 dC (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -4))))) 'ohz1z2)
                                             (CCode "NONBOND_OFF_DIAGONAL_HESSIAN_ACCUMULATE(I1, 2, I2, 2, ohz1z2);")
                                             (make-rule '(+ (* 3 (expt DIELECTRIC -1) dQ1Q2 eelScale (PBX (+ (* -1 x1) x2)) (PBY (+ (* -1 y1) y2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* vdwScale (+ (* 168 dA (PBX (+ (* -1 x1) x2)) (PBY (+ (* -1 y1) y2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* -48 dC (PBX (+ (* -1 x1) x2)) (PBY (+ (* -1 y1) y2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5))))) 'ohx2y2)
                                             (CCode "NONBOND_OFF_DIAGONAL_HESSIAN_ACCUMULATE(I2, 0, I2, 1, ohx2y2);")
                                             (make-rule '(+ (* 3 (expt DIELECTRIC -1) dQ1Q2 eelScale (PBX (+ (* -1 x1) x2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* vdwScale (+ (* 168 dA (PBX (+ (* -1 x1) x2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* -48 dC (PBX (+ (* -1 x1) x2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5))))) 'ohx2z2)
                                             (CCode "NONBOND_OFF_DIAGONAL_HESSIAN_ACCUMULATE(I2, 0, I2, 2, ohx2z2);")
                                             (make-rule '(+ (* 3 (expt DIELECTRIC -1) dQ1Q2 eelScale (PBY (+ (* -1 y1) y2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5/2)) (* vdwScale (+ (* 168 dA (PBY (+ (* -1 y1) y2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -8)) (* -48 dC (PBY (+ (* -1 y1) y2)) (PBZ (+ (* -1 z1) z2)) (expt (+ (expt (PBX (+ (* -1 x1) x2)) 2) (expt (PBY (+ (* -1 y1) y2)) 2) (expt (PBZ (+ (* -1 z1) z2)) 2)) -5))))) 'ohy2z2)
                                             (CCode "NONBOND_OFF_DIAGONAL_HESSIAN_ACCUMULATE(I2, 1, I2, 2, ohy2z2);")
                                             (CCode "} /*if calcOffDiagonalHessian */ ")
                                             (CCode "#endif /* NONBOND_CALC_OFF_DIAGONAL_HESSIAN ]*/")
                                             (CCode "} /*calcDiagonalHessian */")
                                             (CCode "#endif /* NONBOND_CALC_DIAGONAL_HESSIAN ]*/")
                                             (CCode "} /*calcForce */")
                                             (CCode "#endif /* NONBOND_CALC_FORCE ]*/")
                                             (CCode "NONBOND_DEBUG_INTERACTIONS(I1,I2);")
                                             (CCode "SKIP_term: (void)0;"))))





